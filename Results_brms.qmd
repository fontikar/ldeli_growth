---
title: 'Results brms text for ldeli growth'
author: Fonti Kar
date: "`r Sys.Date()`"
output: 
  word_document:
    reference_docx: "Style_guide.docx"
---

```{r setup, include=FALSE, eval = T, echo = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 2)
rm(list=ls())
sessionInfo()

# R version 3.6.1 (2019-07-05)
# Platform: x86_64-apple-darwin15.6.0 (64-bit)
# Running under: macOS High Sierra 10.13.6

pacman::p_load(dplyr, magrittr, ggplot2, patchwork, lubridate, stringr, tidyr, MCMCglmm, bookdown, pander, brms, janitor, purrr, tidybayes, stringr, latex2exp, tidybayes, bayestestR, kinship2, xlsx, patchwork, ggrepel, magick, readxl, officer)

#Read in dataset
#Complete
data <- read.csv("./data/growth/processed/analysis/Ldeli_quangen_growth_for_analysis.csv", stringsAsFactors = F)
str(data)
dim(data)

#Augmented
data_DA <- read.csv("./data/growth/processed/analysis/Ldeli_quangen_growth_DA.csv", stringsAsFactors = F)
str(data_DA)
dim(data_DA)

#ggplot theme
my_theme <- theme(#legend.position = "none",
  legend.position = "bottom",
  legend.text =element_text(size = 14),
  legend.title =element_text(size = 14, face = "bold"),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(),
  axis.text=element_text(size=16),
  axis.title=element_text(size=16,face="bold"),
  plot.title = element_text(size = 20, face = "bold", hjust = 0.5))

source("./R/Analysis/functions.R")
```

```{r, echo = FALSE, warning = FALSE}
#| echo: false
#| warning: false
#| message: false

# Explore pedigree a bit
  data_ped <- data %>% group_by(dam_id)  %>% summarise(n_babes = length(unique(liz_id)), n_sires = length(unique(sire_id))) %>% as.data.frame()

  pedigree_stats <- data %>% group_by(treatment, dam_id, sire_id)  %>% summarise(n_offspring = length(unique(liz_id))) %>% as.data.frame()
```

# Results

```{r, echo = FALSE, include = FALSE}
data %>% nrow()
data %>% select()

#Total number of lizards
data$liz_id %>% unique() %>% length()

#How many lizards per treatment
treat_lizards <- data %>% group_by(treatment) %>%
  summarise(Num_individuals = length(unique(liz_id)))

#How old were lizards
age_dat <-data %>% group_by(liz_id, treatment) %>%
  summarise(max_age = max(days_since_hatch))
age_dat %>% filter(treatment == 29) %>% pull(max_age) %>% mean() %>% round(2)
age_dat %>% filter(treatment == 29) %>% pull(max_age) %>% min() %>% round(2)
age_dat %>% filter(treatment == 29) %>% pull(max_age) %>% max() %>% round(2)

age_dat %>% filter(treatment == 23) %>% pull(max_age) %>% mean() %>% round(2)
age_dat %>% filter(treatment == 23) %>% pull(max_age) %>% min() %>% round(2)
age_dat %>% filter(treatment == 23) %>% pull(max_age) %>% max() %>% round(2)

age_dat %>% pull(max_age) %>% mean() %>% round(2)
age_dat %>% pull(max_age) %>% sd() %>% round(2)

#How many measurements per lizard
num_meas_dat <- data %>% group_by(liz_id, treatment) %>%
  summarise(Num_measures = length(liz_id)) %>% as.data.frame()
mean(num_meas_dat$Num_measures) %>% round(2)
sd(num_meas_dat$Num_measures) %>% round(2)

#Merge 
measures_age <- left_join(num_meas_dat, age_dat) 
measures_age %>% filter(Num_measures >= 11.5) %>% pull(max_age) %>% mean()
measures_age %>% filter(Num_measures >= 11.5) %>% pull(max_age) %>% sd()

```

Over two years,  we collected `r data %>% nrow()` observations of mass data for a total of `r data$liz_id %>% unique() %>% length()` individuals ($n_{hot}$ = `r treat_lizards[2,2]`, $n_{cold}$ = `r treat_lizards[1,2]`). On average, the incubation period for the ‘hot’ treatment was 29.36 days (SD = 2.17, range = 15 - 49) days and 48.48 days (SD = 4.18, range = 25 - 56) for the ‘cold’ treatment. The average age for hot incubated lizards was `r age_dat %>% filter(treatment == 29) %>% pull(max_age) %>% mean() %>% round(2)` (range: `r age_dat %>% filter(treatment == 29) %>% pull(max_age) %>% min() %>% round(2)` -- `r age_dat %>% filter(treatment == 29) %>% pull(max_age) %>% max() %>% round(2)`) and for cold incubated lizards it was `r age_dat %>% filter(treatment == 23) %>% pull(max_age) %>% mean() %>% round(2)` (range: `r age_dat %>% filter(treatment == 23) %>% pull(max_age) %>% min() %>% round(2)` -- `r age_dat %>% filter(treatment == 23) %>% pull(max_age) %>% max() %>% round(2)`). 

## The influence of developmental temperature on additive genetic variance and maternal effects across age 

```{r, echo = FALSE, warning = FALSE, include = FALSE, message = FALSE}
#Marginalised over age - PIE CHART
#Read in intercept models
  brm_10_cold <- readRDS("./output/rds/brm_10_cold") #brm_10_cold
  brm_10_hot <- readRDS("./output/rds/brm_10_hot") #brm_10_hot

#Extract VCV
  brm_10_cold_post <- posterior_samples(brm_10_cold) 
  brm_10_hot_post <- posterior_samples(brm_10_hot) 

#Calculate total phenotypic variance for each treatment
Hot_Pheno_intercept <- brm_10_hot_post[,"sd_F1_Genotype__Intercept"]^2 +
  brm_10_hot_post[,"sd_dam_id__Intercept"]^2 + 
  brm_10_hot_post[,"sigma"]^2

cold_Pheno_intercept <- brm_10_cold_post[,"sd_F1_Genotype__Intercept"]^2 +
  brm_10_cold_post[,"sd_dam_id__Intercept"]^2 + 
  brm_10_cold_post[,"sigma"]^2

#Create a table
hot_cold_Vcomps <- as.data.frame(matrix(ncol = 5, nrow = 8))
colnames(hot_cold_Vcomps) <- c("Treatment", "Variable", "Estimate", "Lower", "Upper")

hot_cold_Vcomps$Treatment <- rep(c("Hot", "Cold"), each =4)
hot_cold_Vcomps$Variable <-rep(c("V_additive_g", "V_maternal",  "Vresidual", "h2"), 2)

#Fill in table
hot_cold_Vcomps[1,3:5] <- ((brm_10_hot_post[,"sd_F1_Genotype__Intercept"])^2 %>% posterior_summary())[-2] %>% round(3)
hot_cold_Vcomps[2,3:5] <- ((brm_10_hot_post[,"sd_dam_id__Intercept"])^2 %>% posterior_summary())[-2]%>% round(3)
hot_cold_Vcomps[3,3:5] <- ((brm_10_hot_post[,"sigma"])^2 %>% posterior_summary())[-2]%>% round(3)
hot_cold_Vcomps[4,3:5] <- ((brm_10_hot_post[,"sd_F1_Genotype__Intercept"]^2 / Hot_Pheno_intercept) %>% posterior_summary())[-2] %>% round(3)

hot_cold_Vcomps[5,3:5] <- ((brm_10_cold_post[,"sd_F1_Genotype__Intercept"])^2 %>% posterior_summary())[-2]%>% round(3)
hot_cold_Vcomps[6,3:5] <- ((brm_10_cold_post[,"sd_dam_id__Intercept"])^2 %>% posterior_summary())[-2]%>% round(3)
hot_cold_Vcomps[7,3:5] <- ((brm_10_cold_post[,"sigma"])^2 %>% posterior_summary())[-2]%>% round(3)
hot_cold_Vcomps[8,3:5] <- ((brm_10_cold_post[,"sd_F1_Genotype__Intercept"]^2 / cold_Pheno_intercept) %>% posterior_summary())[-2]%>% round(3)

#Plot this
rerun = FALSE
if(rerun) {
  wesanderson::wes_palette("Darjeeling2") %>% str()

cold_pieplot <- hot_cold_Vcomps %>% filter(Treatment == "Cold"  & ! Variable == "h2") %>% 
  mutate(csum = rev(cumsum(rev(Estimate))), 
         pos = Estimate/2 + lead(csum, 1),
         pos = if_else(is.na(pos), Estimate/2, pos),
         labels = c("V_{G}", "V_{M}", "V_{R}"),
         full_lab = paste0(labels, " = ", Estimate, " (", Lower, ",", Upper, ")"))

cold_pie <- ggplot(cold_pieplot, aes(y = Estimate, x = "", fill = Variable)) + 
  geom_bar(stat="identity", width=1)  + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values = c("#046C9A", "#ffa000" , "#008888")) + 
  theme_void() + 
  labs(title = "Cold Incubation Treatment") + 
  geom_label_repel(data = cold_pieplot,
                   aes(y = pos, label = full_lab),
                   size = 3.5, nudge_x = 1, show.legend = FALSE) +
                   theme(plot.title = element_text(hjust = 0.5, face = "bold"),
                        legend.position = "none")

hot_pieplot <- hot_cold_Vcomps %>% filter(Treatment == "Hot" & ! Variable == "h2") %>% 
mutate(csum = rev(cumsum(rev(Estimate))), 
         pos = Estimate/2 + lead(csum, 1),
         pos = if_else(is.na(pos), Estimate/2, pos),
         labels = c("$V_{G}$", "$V_{M}$", "$V_{R}$"),
         full_lab = paste0(labels, " = ", Estimate, " (", Lower, ",", Upper, ")")) 

hot_pie <- ggplot(hot_pieplot, aes(y = Estimate, x = "", fill = Variable)) + 
  geom_bar(stat="identity", width=1)  + 
  coord_polar("y", start=0) + 
  scale_fill_manual(values = c("#046C9A", "#ffa000" , "#008888")) + 
  theme_void() + labs(title = "Hot Incubation Treatment") + geom_label_repel(data = hot_pieplot,
                   aes(y = pos, label = full_lab),
                   size = 3.5, nudge_x = 1, show.legend = FALSE) + theme(plot.title = element_text(hjust = 0.5, face = "bold"),
                        legend.position = "none")

# Save plot()
  ggsave(cold_pie + hot_pie, filename = "./output/figures/fig1.pdf", width = 7.629630, height = 4.271605)
} else {
  plot <- image_read("./output/figures/fig1.pdf")
  plot
}
#These were saved as pdf and labels were added via PowerPoint

#Test for differences HOT  - COLD
#Overall variance
diff_Pheno_intercept <- Hot_Pheno_intercept - cold_Pheno_intercept
posterior_summary(diff_Pheno_intercept)

#Additive genetic variance
diff_Vg <- (brm_10_hot_post[,"sd_F1_Genotype__Intercept"]^2) - (brm_10_cold_post[,"sd_F1_Genotype__Intercept"])^2
posterior_summary(diff_Vg)

#Maternal variance
diff_Vm <- (brm_10_hot_post[,"sd_dam_id__Intercept"]^2) - (brm_10_cold_post[,"sd_dam_id__Intercept"])^2
posterior_summary(diff_Vm)

#Residual variance
diff_Ve <- (brm_10_hot_post[,"sigma"]^2) - (brm_10_cold_post[,"sigma"])^2
posterior_summary(diff_Ve)

#h2
diff_h2 <- (brm_10_hot_post[,"sd_F1_Genotype__Intercept"]^2 / Hot_Pheno_intercept) - (brm_10_cold_post[,"sd_F1_Genotype__Intercept"]^2 / cold_Pheno_intercept)
posterior_summary(diff_h2)

```

Overall, additive genetic variance and heritability ($h^2$) of growth appears to be higher in the hot developmental temperature treatment (@fig-fig1). However, there were no significant differences among treatment groups (Table S3). 

```{r}
#| label: fig-fig1
#| echo: false
#| fig-cap: Pie charts depicting the overall relative contributions of mass variance for the hot (nlizards  = 126) and cold (nlizards  =136) developmental treatment group irrespective of age. Point estimates and 95% credible intervals are presented in Table S3. There were no significant differences in variance components between developmental temperature treatments. * in indicates very small values that were above 0.The influence of developmental temperature on genetic and non-genetic variance across age 

fig1 <- image_read("./output/figures/fig1_edited.pdf")
fig1
```

Treatment groups did not differ in how the relative contributions of $G$ and $M$ changed with age as their 95% credible intervals overlapped (Fig. S1). Additive genetic variance remained relatively low and constant upon emergence until approximately nine months of age, after which it increased rapidly (Fig. S1). Maternal effects decreased sharply upon hatching and dropped to the minimum at approximately six months before it increased again (Fig. S1). There were some differences among developmental treatments in how residual variance changed with age (Fig. S1). 

```{r, echo = FALSE, warning = FALSE, include = FALSE}
#Estimates of variance components G M E over age
#Read in model output
brm_12_cold_het <- readRDS("./output/rds/brm_12_cold_het") 
 brm_12_hot_het <- readRDS("./output/rds/brm_12_hot_het")

#Define the days to calculate estimates
  z_days <- ztran_DsH(seq(0, 450, 30), data = data_DA)

#Get estimates across age for hot treatment
  brms_hot_Vg <- lapply(z_days, function(x) brms_Vcomp(model = brm_12_hot_het, x = x, group_var = "F1_Genotype", data = data_DA)) %>% bind_rows()
  brms_hot_Vm <- lapply(z_days, function(x) brms_Vcomp(model = brm_12_hot_het, x = x, group_var = "dam_id", data = data_DA)) %>% bind_rows()
  brms_hot_Ve <- lapply(z_days, function(x) brms_Vcomp(model = brm_12_hot_het, x = x, group_var = "sigma", data = data_DA)) %>% bind_rows()


#Compile all variance estimates together
  brms_hot <- bind_rows(brms_hot_Vg,
                      brms_hot_Vm,
                      brms_hot_Ve)

#Add in treatment info
  brms_hot$Treatment <- "Hot"

#Obtain estimates for cold treatment
  brms_cold_Vg <- lapply(z_days, function(x) brms_Vcomp(model = brm_12_cold_het, x = x, group_var = "F1_Genotype", data = data_DA)) %>% bind_rows()
  brms_cold_Vm <- lapply(z_days, function(x) brms_Vcomp(model = brm_12_cold_het, x = x, group_var = "dam_id", data = data_DA)) %>% bind_rows()
  brms_cold_Ve <- lapply(z_days, function(x) brms_Vcomp(model = brm_12_cold_het, x = x, group_var = "sigma", data = data_DA)) %>% bind_rows()

#Compile all variance estimates together
  brms_cold <- bind_rows(brms_cold_Vg,
                       brms_cold_Vm,
                       brms_cold_Ve)
# Add in treatment info                       
  brms_cold$Treatment <- "Cold"              

#Put both datasets together
  brms_compare <- bind_rows(brms_hot, brms_cold)

#Change the labels for each panel
  group_var_labs_3 <- c("G  ", "M  ", "Residual")

  names(group_var_labs_3) <- unique(brms_compare$group_id)

#Change order of labels
  brms_compare$group_id<- factor(brms_compare$group_id , levels = c("F1_Genotype", "dam_id", "sigma"))
  brms_compare$treatment<- factor(brms_compare$Treatment , levels = c("Cold", "Hot"), labels = c("Cold", "Hot"))
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
#Plot the figure comparing treatments and variance components
ggplot(data = brms_compare, aes(x = day, y = Estimate, colour = factor(treatment))) +
  geom_point(size = 2) + 
  #geom_errorbar(aes(min = Lower, max = Upper), width = 0, alpha = 0.5) + 
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.05) +
  #geom_smooth(aes(ymin = Lower, ymax = Upper), stat = "identity", alpha = 0.1) +
  #geom_line() + 
  stat_smooth(method = "auto", se = F, size = 1) + 
  facet_wrap(~group_id, scales = "free_y", labeller = labeller(group_id = group_var_labs_3)) + 
  scale_x_continuous(breaks = seq(0, 500, 60)) + 
  #scale_colour_manual(values = c("#5BBCD6", "#F98400")) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) + 
  labs(x = "Age",
       y = "Variance of Mass",
       #title = "Relative contribution of variance over age",
       colour =  "Treatment") + 
  theme_bw() + 
  my_theme +
  theme(legend.position = "none",
        strip.text = element_text(size = 18, face = "bold"),
        strip.background = element_blank())
ggsave(filename = "./output/figures/fig2.pdf", width = 13.419753, height = 5.740741)
```

We investigated whether increases in mass mean over time would result in scale effects that can bias variance estimates. We found that CV of G and M followed the same pattern was the raw variance estimates and conclude that scale effects did not influence our results (Fig. S2).

After accounting for heterogenous residual variance, we found no differences in $h^2$ or the proportion of variance explained by maternal effects ($M^2$) (Fig.2). Heritability was very low for the first year of growth in L.deliata and only began increasing at one year of age (Fig. 2). As predicted $M^2$ decreased since hatching, however it increased slightly from six months of age (Fig. 2). The $G$ and $M$ matrices for each treatment group are presented in Table S6-S7.

```{r, echo = FALSE, warning = FALSE, message = FALSE, include = FALSE}
#Estimating h2 and m2 over age
brm_12_cold_het <- readRDS("./output/rds/brm_12_cold_het") #brm_12_cold_het
 brm_12_hot_het <- readRDS("./output/rds/brm_12_hot_het") #brm_12_hot_het

#Define the days
z_days <- ztran_DsH(seq(0, 450, 30), data = data_DA)

#Compiling heritability and maternal effects estimates across days
#Hot developmental temperature model
brms_hot_h2 <- lapply(z_days, function(x) brms_h2(model = brm_12_hot_het, z_age = x, G = "F1_Genotype", M = "dam_id", data = data_DA)) %>% bind_rows()
brms_hot_m2 <- lapply(z_days, function(x) brms_m2(model = brm_12_hot_het, z_age = x, G = "F1_Genotype", M = "dam_id", data = data_DA)) %>% bind_rows()

#Putting it together in one data frame
brms_hot_h2m2 <- bind_rows(brms_hot_h2, 
                           brms_hot_m2)

#Assigning treatment
brms_hot_h2m2$treatment <- "hot"

#Cold developmental temperature model
brms_cold_h2 <- lapply(z_days, function(x) brms_h2(model = brm_12_cold_het, z_age = x, G = "F1_Genotype", M = "dam_id", data = data_DA)) %>% bind_rows()
brms_cold_m2 <- lapply(z_days, function(x) brms_m2(model = brm_12_cold_het, z_age = x, G = "F1_Genotype", M = "dam_id", data = data_DA)) %>% bind_rows()

#Putting it together in one data frame
brms_cold_h2m2 <- bind_rows(brms_cold_h2, 
                            brms_cold_m2)

#Assigning treatment
brms_cold_h2m2$treatment <- "cold"

#Putting hot and cold values together into one dataframe for plotting
brms_h2m2 <- bind_rows(brms_hot_h2m2, brms_cold_h2m2)

```

```{r, echo = FALSE}
#| label: fig-fig2
#| fig-cap: fig3
#Plotting figure
brms_top_2 <- ggplot(data = brms_h2m2 %>% filter(group_id == "h2"), aes(x = day, y = Estimate, colour = factor(treatment))) +
  geom_point(size = 2) + 
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.05) +
  geom_line(size = 1) + 
  scale_x_continuous(breaks = seq(0, 450, 60)) + 
  scale_y_continuous(lim = c(0,0.6)) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) + 
  labs(x = " ",
       y = TeX("$h^2$"),
       #title = "Relative contribution of variance over age",
       colour =  "Treatment") + 
  theme_bw() + 
  my_theme +
  theme(legend.position = "none",
        strip.text = element_text(size = 18),
        strip.background = element_blank())

brms_bottom_2 <- ggplot(data = brms_h2m2 %>% filter(group_id == "m2"), aes(x = day, y = Estimate, colour = factor(treatment))) +
  geom_point(size = 2) + 
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.05) +
  geom_line(size = 1) + 
  scale_x_continuous(breaks = seq(0, 450, 60)) + 
  scale_y_continuous(lim = c(0,1)) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) + 
  labs(y = TeX("$M^2$"),
       x = "Age",
       colour = "Treatment") + 
  theme_bw() + 
  my_theme +
  theme(legend.position = "none",
        strip.text = element_text(size = 18),
        strip.background = element_blank())

((brms_top_2) / (brms_bottom_2)) + plot_annotation(tag_levels = "A", tag_suffix = ")") + theme(plot.tag =  element_text(size = 20, face = "bold"))
```

## Do growth rate curves differ between incubation treatments? 

```{r, eval = FALSE, echo = FALSE, include = FALSE}
#Compare WAIC of fixed effect models
#Read in fixed effect models
    brm_5.het <- readRDS("./output/rds/brm_12_het_fixed1") #old_models/brm_5.het
  brm_5.1.het <- readRDS("./output/rds/brm_12_het_fixed2") #old_models/brm_5.1.het
brm_5.1.5.het <- readRDS("./output/rds/brm_12_het_fixed3") #old_models/brm_5.1.5.het
  brm_5.2.het <- readRDS("./output/rds/brm_12_het_fixed4") #old_models/brm_5.2.het

#Add the WAIC
    waic_5.het <- waic(brm_5.het)
  waic_5.1.het <- waic(brm_5.1.het)
waic_5.1.5.het <- waic(brm_5.1.5.het)
  waic_5.2.het <- waic(brm_5.2.het)

# LOO
    loo_5.het <- loo(brm_5.het, "loo", moment_match = TRUE)
  loo_5.1.het <- loo(brm_5.1.het, "loo", moment_match = TRUE)
loo_5.1.5.het <- loo(brm_5.1.5.het,  "loo", moment_match = TRUE)
  loo_5.2.het <- loo(brm_5.2.het, "loo", moment_match = TRUE)
 
#Compare
  tab_fixed_waic <- data.frame(loo_compare(waic_5.het, waic_5.1.het, waic_5.1.5.het, waic_5.2.het)) %>% select(waic, elpd_diff, se_diff) %>% mutate(id= row.names(.))
  tab_fixed_loo <- data.frame(loo_compare(loo_5.het, loo_5.1.het, loo_5.1.5.het, loo_5.2.het)) %>% select(looic, elpd_diff, se_diff)  %>% mutate(id= row.names(.))

# Merge IC dataframes
  tab_fixed <- left_join(tab_fixed_waic, tab_fixed_loo, by = "id", suffix = c("_waic", "_loo"))  %>% relocate(id, .before = waic) 
  model_struc_name <- c("Treatment + Age + Age^2 + Treatment \\cdot Age + Treatment \\cdot Age^2", "Treatment + Age + Age^2+ Treatment \\cdot Age^2", "Treatment + Age + Age^2", "Treatment + Age + Age^2 + Treatment \\cdot Age")
  tab_fixed <- tab_fixed %>% mutate(model = model_struc_name) %>% relocate(model, .after = id)

# write file to save time
  write_xlsx(tab_fixed, "./output/tables/brms_fixed.xlsx")
```

```{r, echo = FALSE, warning = FALSE}
#| label: tbl-tab1
#| tbl-cap: Coefficient estimates from full model testing the effects of developmental treatment on mass and how mass changes with age. Bolded estimates are significantly different from zero. * indicates that value is above zero prior to rounding. nobs = 2926. Age measured in days was z-transformed (mean = 361.34, SD = 185.16). G and M matrices for this model are presented in Table S6

#Table 2
tab2 <- data.frame(readxl::read_xlsx("./output/tables/brms_fixed.xlsx") %>% dplyr::select(-id, -matches("waic"))  %>% arrange(looic))

flextable::flextable(tab2)  %>% flextable::width(j = 1, width = 5)  %>% flextable::autofit()
```

```{r, echo = FALSE, warning = FALSE, include = FALSE}

# Load model
 brm_5.het <- readRDS("./output/rds/brm_12_het_fixed1") #old_models/brm_5.het
 brm_5.2.het <- readRDS("./output/rds/brm_12_het_fixed4") #old_models/brm_5.2.het

# What is the R2 for the top model?
  r2_fixed_main <- bayes_R2(brm_5.2.het)

#Calculating inital mass. Extract posterior from the full model. We can marginalise coefficients anyway.
  brm_5.het_post <- posterior_samples(brm_5.het)

# Overall linear growth rate for cold
  growth_rate_cold <- brm_5.het_post[,"b_z_days_since_hatch"] %>% exp() 

# Overall linear growth rate for hot
  growth_rate_hot <- brm_5.het_post[,"b_z_days_since_hatch"] + brm_5.het_post[,"b_treatment29:z_days_since_hatch"] %>% exp() 

# Average / marginalised growth rate
  growth_rate <- c(growth_rate_cold, growth_rate_hot)  %>% posterior_summary() %>% round(3)

# Cold mass at hatch. Convert back from log (grams) to grams.
  cold_intercept <- brm_5.het_post[,"b_Intercept"] %>% exp()
  posterior_summary(cold_intercept)
  mean(cold_intercept)

# Hot mass at hatch. Convert back from log (grams) to grams.
  hot_intercept <- (brm_5.het_post[,"b_Intercept"] + brm_5.het_post[,"b_treatment29"]) %>% exp()
  posterior_summary(hot_intercept)
  mean(hot_intercept)

#Difference in mass at hatching
  diff <- (cold_intercept - hot_intercept)  %>% posterior_summary() %>% round(3)
```

While the model containing an full interaction between treatment and linear and quadratic age was best supported, the improvement was marginal and our main effects model explained substantial amount of variation in mass overall ($R^2$ = `r r2_fixed_main[1]`, 95% CI: `r r2_fixed_main[3]` to `r r2_fixed_main[4]`; @tbl-tab1). Developmental temperature did impacted initial mass (Table 1, @fig-fig3). Lizards from the oldtreatment were, on average, `r diff[,"Estimate"]`g (95% CI: `r diff[,"Q2.5"]` to `r diff[,"Q97.5"]`g) heavier compared to lizards from the ottreatment (@tbl-tbl2). However, the linear growth rate (Age) and nonlinear growth trajectory ($Age^2$) did not differ significantly between the two developmental temperature treatments (Table S5, Table S7-S9). Irrespective of treatment, lizard mass increased by `r growth_rate[1]`g for every 1 SD unit increase in age (95% CI: `r growth_rate[3]` to `r growth_rate[4]`).  

```{r, echo = FALSE, cache = TRUE, warning = FALSE, include = FALSE, cache = TRUE}
#Figure 3 of model predictions showing intercept differences

# Subset data
  predat <- data_DA %>% select(F1_Genotype, dam_id, treatment) %>% distinct()

# Create a vector of age for predcition. We'll predcit to 400 days. On z_scale.
  z_days <- ztran_DsH(seq(0, 450, 30), data = data_DA)

# Back transform to the raw days 
  days <- backztran_DSH(z_days, data = data_DA)

# Create the dataframe for making predictions.
  df <- bind_rows(lapply(days, function(x) func_growth_predictions(x, predat = predat, posterior = brm_5.het_post, data = data_DA)))
```

```{r, echo = FALSE, warning = FALSE}
#| label: fig-fig3
#| fig-cap: Model predictions of log-transformed mass over age from the two developmental temperatures. We randomly subset 40 lizards (20 from each treatment) to plot their individual growth curves. Points represent mean estimates for each lizard from the hot developmental treatment (hot) and the cold developmental treatment (blue). Thick lines represent average growth curve for each treatment. Faint grey lines are each individual’s growth curve. Model predictions were generated from the full model where interaction terms between treatment and both the linear component and quadratic component were included

#Generationg Figure 3
hot_ids <- df %>% filter(treatment == "29") %>% pull(liz_id) %>% unique()
set.seed(6)
hot_plot_ids <- as.character(sample(hot_ids, 20, replace = T))

cold_ids <- df %>% filter(treatment == "23") %>% pull(liz_id) %>% unique()
set.seed(6)
cold_plot_ids <- as.character(sample(cold_ids, 20, replace = T))

df %>% filter(liz_id %in% c(hot_plot_ids, cold_plot_ids)) %>%
  ggplot(
    aes(x = day, y = mean_mass)) + 
  stat_smooth(aes(group = factor(liz_id)), 
              method = "lm", formula = y ~ x + I(x^2), size = 0.1, se = F, colour = "black", alpha = 0.01) + 
  stat_smooth(aes(colour = factor(treatment)), 
              method = "lm", formula = y ~ x + I(x^2), size = 2, se = F, alpha = 0.01) + 
  scale_colour_manual(values = c("#2790F3", "#F24D2A")) + 
  labs(x = "Age",
       y = "Log transformed Mass",
       #title = "Model predictions N = 40",
       colour =  "Treatment") +
  theme_bw() + 
  my_theme
```

```{r, echo = FALSE, warning = FALSE}
#| label: tbl-tbl2
#| tbl-cap: Coefficient estimates from full model testing the effects of developmental treatment on mass and how mass changes with age. Bolded estimates are significantly different from zero. * indicates that value is above zero prior to rounding. nobs = 2926. Age measured in days was z-transformed (mean = 361.34, SD = 185.16). G and M matrices for this model are presented in Table S6

 tble2 <- posterior_samples(brm_5.het, pars = "^b")   %>% 
          select(-matches("sigma"))                   %>% 
          posterior_summary()                         %>% 
          data.frame()                                %>% 
          round(3)                                    %>% 
          mutate(Parameter = c("Intercept",
                                "Treatment (29)",
                                "Age",
                                "Age^2",
                                "Treatment * Age",
                                "Treatment * Age^2")) %>% 
          relocate(Parameter, .before = Estimate)     %>% 
          select(-Est.Error)                                    

  flextable::flextable(tble2) %>% flextable::width(j = 1, width = 3)  %>% flextable::autofit()
```

